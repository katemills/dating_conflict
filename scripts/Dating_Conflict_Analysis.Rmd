---
title: "Dating Conflict Analysis"
author: "Kate Mills"
date: "October 3, 2017"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```

Load required packages and scripts (no input needed)
```{r setup, include=FALSE}
knitr::opts_chunk$set(
	message = FALSE,
	warning = FALSE,
	include = FALSE
)
packages <- c( "tidyverse", "nlme", "lme4", "RODBC", "data.table",
               "ggplot2")
if (length(setdiff(packages, rownames(installed.packages()))) > 0) {
  install.packages(setdiff(packages, rownames(installed.packages())))
}
lapply(packages, library, character.only = TRUE)
workdir=substring(paste0(getwd()),0,53)
```

Load data
```{r, include=FALSE}
conn <- RODBC::odbcConnect(dsn="PInf1")
participants <- data.table(RODBC::sqlQuery(conn,"SELECT * From PInf1.dbo.SMaster")) %>%
  select(SID,Gender,Latino,EthWhite,EthBlack,EthAsian,EthNAm,EthPacIs,EthOther)
surveydata <- data.table(RODBC::sqlQuery(conn,"SELECT * From PInf1.dbo.SWave"))
rm(conn)
```

Clean data
```{r, include=FALSE}
demographics <- participants %>%
  mutate(Ethnicity=ifelse(rowSums(select(., contains("Eth")),na.rm = TRUE)>1,"Multiethnic",
                          ifelse(rowSums(select(., contains("Eth")),na.rm = TRUE)<1,NA,
                          1))) %>%
  mutate(Ethnicity=ifelse(!Ethnicity=="Multiethnic" & EthWhite==1,"White",
                          ifelse(!Ethnicity=="Multiethnic" & EthOther==1,"Other",
                                 ifelse(!Ethnicity=="Multiethnic" & EthBlack==1,"AfricanAmerican",
                                 ifelse(!Ethnicity=="Multiethnic" & EthAsian==1,"AsianAmerican",
                                        ifelse(!Ethnicity=="Multiethnic" & EthNAm==1,"NativeAmerican",
                                               ifelse(!Ethnicity=="Multiethnic" & EthPacIs==1,"PacificIslander",
                                                      Ethnicity))))))) %>%
  select(SID,Gender,Ethnicity, Latino)

puberty<-left_join(demographics,(surveydata %>%
                                   select(SID,WID,contains("Pub")))) %>%
  mutate(PubSpurt=PubSpurt+1,
         PubHair=PubHair+1,
         PubZits=PubZits+1,
         PubVoice=PubVoice+1,
         PubFace=PubFace+1,
         PubBreast=PubBreast+1,
         MensesStarted=ifelse(PubMenses==0,1,
                              ifelse(PubMenses>0,4,NA))) %>%
  mutate(PDS_Female=ifelse(Gender==0,rowMeans(cbind(PubSpurt,PubHair,PubZits,PubBreast,MensesStarted),na.rm = FALSE),NA),
         PDS_Male=ifelse(Gender==1,rowMeans(cbind(PubSpurt,PubHair,PubZits,PubVoice,PubFace),na.rm = FALSE),NA),
         Puberty_Category=ifelse(Gender==0,
                                 ifelse(rowSums(cbind(PubHair,PubBreast),na.rm=TRUE)==2 & MensesStarted==1,"Prepubertal",
                                 ifelse(rowSums(cbind(PubHair,PubBreast),na.rm=TRUE)==3 & MensesStarted==1,"Early Pubertal",
                                 ifelse(rowSums(cbind(PubHair,PubBreast),na.rm=TRUE)>3 & MensesStarted==1,"Midpubertal",
                                 ifelse(rowSums(cbind(PubHair,PubBreast),na.rm=TRUE)<= 7 & MensesStarted==4,"Late pubertal",
                                 ifelse(rowSums(cbind(PubHair,PubBreast),na.rm=TRUE)==8 & MensesStarted==4,"Postpubertal",NA))))),
                            ifelse(Gender==1,
                                 ifelse(rowSums(cbind(PubHair,PubVoice,PubFace),na.rm=TRUE)==3,"Prepubertal",
                                 ifelse(rowSums(cbind(PubHair,PubVoice,PubFace),na.rm=TRUE)>3 &
                                          rowSums(cbind(PubHair,PubVoice,PubFace),na.rm=TRUE)<6,"Early Pubertal",
                                 ifelse(rowSums(cbind(PubHair,PubVoice,PubFace),na.rm=TRUE)>5&
                                          rowSums(cbind(PubHair,PubVoice,PubFace),na.rm=TRUE)<9,"Midpubertal",
                                 ifelse(rowSums(cbind(PubHair,PubVoice,PubFace),na.rm=TRUE)>8&
                                          rowSums(cbind(PubHair,PubVoice,PubFace),na.rm=TRUE)<12,"Late pubertal",
                                 ifelse(rowSums(cbind(PubHair,PubVoice,PubFace),na.rm=TRUE)==12,"Postpubertal",NA))))),NA)),
         PeriodStartAge=ifelse(PubMenses==0,0,
                            ifelse(!PubMenses==0,PubMenses+5,NA))) %>%
  select(-PubSpurt,-PubZits,-PubHair,-PubBreast,-PubVoice,-PubFace,-PubMenses,-PubKiss)

opportunities<-surveydata %>% 
  select(SID,WID,Kiss3Mo,Laid3Mo,PartyNA3Mo) %>%
  mutate(OppMonitorMean=round(rowMeans(cbind(Kiss3Mo,Laid3Mo,PartyNA3Mo),na.rm=FALSE),2),
         OppMonitorTotal=rowSums(cbind(Kiss3Mo,Laid3Mo,PartyNA3Mo),na.rm=TRUE)) %>%
  filter(!is.na(OppMonitorMean))
```

Descriptives
```{r, include=FALSE}
# Puberty Distribution
Female_Puberty<-ggplot(puberty, aes(x=PDS_Female,
                    colour=as.factor(WID)))+
               geom_density(alpha=.7,
                            size=1.5) +
  labs(x="Pubertal Measure",colour='Wave') +
  ggtitle("Puberty Distribution (Female)") +
  theme_bw() +
  theme_minimal(base_size = 14, base_family = "Arial") +
  theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        legend.position="bottom")
Female_Puberty
ggsave(plot = Female_Puberty,file=paste(workdir,"graphs/Female_PubertybyWave_dist.png",sep = ""),
       width = 6, height = 4, dpi = 300,units="in")

Male_Puberty<-ggplot(puberty, aes(x=Puberty_Male,
                    colour=as.factor(WID)))+
               geom_density(alpha=.7,
                            size=1.5) +
  labs(x="Pubertal Measure",colour='Wave') +
  ggtitle("Puberty Distribution (Male)") +
  theme_bw() +
  theme_minimal(base_size = 14, base_family = "Arial") +
  theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        legend.position="bottom")
Male_Puberty
ggsave(plot = Male_Puberty,file=paste(workdir,"graphs/Male_PubertybyWave_dist.png",sep = ""),
       width = 6, height = 4, dpi = 300,units="in")


puberty_dist_grade8<-puberty %>%
                                  filter(WID==1,!is.na(Puberty_Category)) %>%
                                  group_by(Puberty_Category,Gender) %>%
                                  summarize(n()) 
# Opportunities Monitoring
opp_montioring_dist_mean<-ggplot(opportunities, aes(x=OppMonitorMean,
                    colour=as.factor(WID)))+
               geom_density(alpha=.7,
                            size=1.5) +
  labs(x="Opportunities Monitoring",colour='Wave') +
  ggtitle("Opportunities Monitoring (mean) Distribution by Wave") +
  theme_bw() +
  theme_minimal(base_size = 14, base_family = "Arial") +
  theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        legend.position="bottom")
opp_montioring_dist_mean
ggsave(plot = opp_montioring_dist_mean,file=paste(workdir,"graphs/opp_montioring_dist_mean.png",sep = ""),
       width = 6, height = 4, dpi = 300,units="in")

opp_montioring_dist_total<-ggplot(opportunities, aes(x=OppMonitorTotal,
                    colour=as.factor(WID)))+
               geom_density(alpha=.7,
                            size=1.5) +
  labs(x="Opportunities Monitoring",colour='Wave') +
  ggtitle("Opportunities Monitoring (total) Distribution by Wave") +
  theme_bw() +
  theme_minimal(base_size = 14, base_family = "Arial") +
  theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        legend.position="bottom")
opp_montioring_dist_total
ggsave(plot = opp_montioring_dist_total,file=paste(workdir,"graphs/opp_montioring_dist_total.png",sep = ""),
       width = 6, height = 4, dpi = 300,units="in")

```

Analyses set up
```{r}

# Question 1:
# Does Gender, Ethnicity, and/or Pubertal Status at Grade 8 predict likelihood to being in situations
# where sexual risk behavior could occur?
# IVs: a) Gender, b) Ethnicity, c) Pubertal Status at Grade 8
# DVs: a) EMA time unsupervised w/ partner at Grade 9 +summer
#      b) Opportunities monitoring score at Grade 9

thedata<-left_join((opportunities %>% filter(WID==c(5))),
                   (puberty %>% filter(WID==1)),
                    by = c("SID")) %>%
  mutate(Gender=ifelse(Gender==0,"Female",
                       ifelse(Gender==1,"Male",NA)),
         Puberty=ifelse(!is.na(Puberty_Female),round(Puberty_Female,0),
                        ifelse(!is.na(Puberty_Male),round(Puberty_Male,0),NA)))

gender_pred_oppmon<-lme(OppMonitorMean ~ Gender, method="ML", random = ~1|SID, data=thedata, na.action=na.exclude)
ethnicity_pred_oppmon<-lme(OppMonitorMean ~ Ethnicity, method="ML", random = ~1|SID, data=thedata, na.action=na.exclude)
puberty_pred_oppmon<-lme(OppMonitorMean ~ ordered(Puberty), method="ML", random = ~1|SID, data=thedata, na.action=na.exclude)
pubertygender_pred_oppmon<-lme(OppMonitorMean ~ ordered(Puberty)*Gender, method="ML", random = ~1|SID, data=thedata, na.action=na.exclude)

anova(gender_pred_oppmon)
anova(ethnicity_pred_oppmon)
anova(puberty_pred_oppmon)
anova(pubertygender_pred_oppmon)



```