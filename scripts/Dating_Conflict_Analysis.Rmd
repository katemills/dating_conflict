---
title: "Dating Conflict Analysis"
author: "Kate Mills"
date: "October 3, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```

Load required packages and scripts (no input needed)
```{r setup, include=FALSE}
knitr::opts_chunk$set(
	message = FALSE,
	warning = FALSE,
	include = FALSE
)
packages <- c( "tidyverse", "nlme", "lme4", "RODBC", "data.table",
               "ggplot2")
if (length(setdiff(packages, rownames(installed.packages()))) > 0) {
  install.packages(setdiff(packages, rownames(installed.packages())))
}
lapply(packages, library, character.only = TRUE)
workdir=substring(paste0(getwd()),0,53)

# Kate's custom theme
theme_kate <- function () { 
    theme_bw() +
  theme_minimal(base_size = 14, base_family = "Avenir") +
  theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        legend.position="bottom")
}
```

Load data
```{r, message=FALSE, warning=FALSE, include=FALSE}
conn <- RODBC::odbcConnect(dsn="PInf1")
participants <- data.table(RODBC::sqlQuery(conn,"SELECT * From PInf1.dbo.SMaster")) %>%
  select(SID,Gender,Latino,EthWhite,EthBlack,EthAsian,EthNAm,EthPacIs,EthOther)
surveydata <- data.table(RODBC::sqlQuery(conn,"SELECT * From PInf1.dbo.SWave"))
rm(conn)

EMA_waves3456<-read.csv("../../EMA_Wave3456.csv",header=TRUE,stringsAsFactors = FALSE)
```

Clean data
```{r, message=FALSE, warning=FALSE, include=FALSE}
# Clean up ethnicity data
demographics <- participants %>%
  mutate(Ethnicity=ifelse(rowSums(select(., contains("Eth")),na.rm = TRUE)>1,"Multiethnic",
                          ifelse(rowSums(select(., contains("Eth")),na.rm = TRUE)<1,NA,
                          1))) %>%
  mutate(Ethnicity=ifelse(!Ethnicity=="Multiethnic" & EthWhite==1,"White",
                          ifelse(!Ethnicity=="Multiethnic" & EthOther==1,"Other",
                                 ifelse(!Ethnicity=="Multiethnic" & EthBlack==1,"AfricanAmerican",
                                 ifelse(!Ethnicity=="Multiethnic" & EthAsian==1,"AsianAmerican",
                                        ifelse(!Ethnicity=="Multiethnic" & EthNAm==1,"NativeAmerican",
                                               ifelse(!Ethnicity=="Multiethnic" & EthPacIs==1,"PacificIslander",
                                                      Ethnicity))))))) %>%
  select(SID,Gender,Ethnicity,Latino)

# Clean up puberty data
puberty<-left_join(demographics,(surveydata %>%
                                   select(SID,WID,contains("Pub")))) %>%
  mutate(PubSpurt=PubSpurt+1,
         PubHair=PubHair+1,
         PubZits=PubZits+1,
         PubVoice=PubVoice+1,
         PubFace=PubFace+1,
         PubBreast=PubBreast+1,
         MensesStarted=ifelse(PubMenses==0,1,
                              ifelse(PubMenses>0,4,NA))) %>%
  mutate(PDS_Female=ifelse(Gender==0,rowMeans(cbind(PubSpurt,PubHair,PubZits,PubBreast,MensesStarted),na.rm = FALSE),NA),
         PDS_Male=ifelse(Gender==1,rowMeans(cbind(PubSpurt,PubHair,PubZits,PubVoice,PubFace),na.rm = FALSE),NA),
         Puberty_Category=ifelse(Gender==0,
                                 ifelse(rowSums(cbind(PubHair,PubBreast),na.rm=TRUE)==2 & MensesStarted==1,"Prepubertal",
                                 ifelse(rowSums(cbind(PubHair,PubBreast),na.rm=TRUE)==3 & MensesStarted==1,"Early Pubertal",
                                 ifelse(rowSums(cbind(PubHair,PubBreast),na.rm=TRUE)>3 & MensesStarted==1,"Midpubertal",
                                 ifelse(rowSums(cbind(PubHair,PubBreast),na.rm=TRUE)<= 7 & MensesStarted==4,"Late pubertal",
                                 ifelse(rowSums(cbind(PubHair,PubBreast),na.rm=TRUE)==8 & MensesStarted==4,"Postpubertal",NA))))),
                            ifelse(Gender==1,
                                 ifelse(rowSums(cbind(PubHair,PubVoice,PubFace),na.rm=TRUE)==3,"Prepubertal",
                                 ifelse(rowSums(cbind(PubHair,PubVoice,PubFace),na.rm=TRUE)>3 &
                                          rowSums(cbind(PubHair,PubVoice,PubFace),na.rm=TRUE)<6,"Early Pubertal",
                                 ifelse(rowSums(cbind(PubHair,PubVoice,PubFace),na.rm=TRUE)>5&
                                          rowSums(cbind(PubHair,PubVoice,PubFace),na.rm=TRUE)<9,"Midpubertal",
                                 ifelse(rowSums(cbind(PubHair,PubVoice,PubFace),na.rm=TRUE)>8&
                                          rowSums(cbind(PubHair,PubVoice,PubFace),na.rm=TRUE)<12,"Late pubertal",
                                 ifelse(rowSums(cbind(PubHair,PubVoice,PubFace),na.rm=TRUE)==12,"Postpubertal",NA))))),NA)),
         PeriodStartAge=ifelse(PubMenses==0,0,
                            ifelse(!PubMenses==0,PubMenses+5,NA))) %>%
  select(-PubSpurt,-PubZits,-PubHair,-PubBreast,-PubVoice,-PubFace,-PubMenses,-PubKiss) %>%
  mutate(Puberty_Category=factor(Puberty_Category,levels = c("Prepubertal", "Early Pubertal", "Midpubertal",
                                                             "Late pubertal","Postpubertal"))) %>%
  mutate(Puberty_3group=ifelse(Gender==0,
                               ifelse(PDS_Female<=3,"less",
                                      ifelse(PDS_Female>3 & PDS_Female<3.8,"avg",
                                             ifelse(PDS_Female>=3.8,"more",NA))),
                               ifelse(Gender==1,
                                      ifelse(PDS_Male<=2.4,"less",
                                             ifelse(PDS_Male>2.4 & PDS_Male<3.2,"avg",
                                                    ifelse( PDS_Male>=3.2,"more",NA))),NA)))

# Calculate the mean and total opportunities monitoring scores
opportunities<-surveydata %>% 
  select(SID,WID,Kiss3Mo,Laid3Mo,PartyNA3Mo) %>%
  mutate(OppMonitorMean=round(rowMeans(cbind(Kiss3Mo,Laid3Mo,PartyNA3Mo),na.rm=FALSE),2),
         OppMonitorTotal=rowSums(cbind(Kiss3Mo,Laid3Mo,PartyNA3Mo),na.rm=TRUE)) %>%
  filter(!is.na(OppMonitorMean))

# Clean oldest partner age to identify the oldest partner by grade 9 (Wave 5)
age_oldest_partner<-surveydata %>% 
  select(SID,WID,AgeOldBFGF2) %>%
  filter(!is.na(AgeOldBFGF2),
         WID==5) %>%
  group_by(SID) %>%
  do({oldest_age<-(sort(.$AgeOldBFGF2,decreasing = TRUE)[[1]])
      dplyr::mutate(.,oldest=oldest_age)
  })

# Calculate the mean and total dating conflict score
dating_conflict<-surveydata %>% 
  select(SID,WID,Jealous,IValued,IDone,MeAngry,MeanTone,PutDown,KepTrak,BlaMe,
         AcFlirt,Fright,MadeFun,TTHurt,TTEnd,TTHit) %>%
  mutate(DatingConflictMean=round(rowMeans(cbind(Jealous,IValued,IDone,MeAngry,MeanTone,PutDown,KepTrak,BlaMe,
         AcFlirt,Fright,MadeFun,TTHurt,TTEnd,TTHit),na.rm=FALSE),2),
         DatingConflictTotal=rowSums(cbind(Jealous,IValued,IDone,MeAngry,MeanTone,PutDown,KepTrak,BlaMe,
         AcFlirt,Fright,MadeFun,TTHurt,TTEnd,TTHit),na.rm=TRUE)) %>%
  filter(!is.na(DatingConflictMean))

EMA_data<-EMA_waves3456 %>%
  mutate(SID=sid) %>%
  select(SID, complete, WID,WithBFGF,AdultPresent,NumAdults,Whereareyou) %>%
  filter(!is.na(WithBFGF),!is.na(AdultPresent)) %>%
  mutate(Location=ifelse(Whereareyou==1,"home",
                  ifelse(Whereareyou==2,"someones_house",
                  ifelse(Whereareyou==3,"school",
                  ifelse(Whereareyou==4,"going_somewhere",
                  ifelse(Whereareyou==5,"out_and_about",NA))))),
         WithBFGF=ifelse(WithBFGF==1,"Yes",
                         ifelse(WithBFGF==0,"No",NA)),
         AdultPresent=ifelse(AdultPresent==1,"Yes",
                         ifelse(AdultPresent==0,"No",NA))) %>%
  select(-Whereareyou) 

NumCompleteEMA<- EMA_data %>%
  group_by(SID,WID,complete) %>%
  summarize(totalEMA=n()) %>%
  ungroup()

EMA_count <- left_join((EMA_data %>%
  group_by(SID,WID,WithBFGF,AdultPresent) %>%
  summarize(count=n()) %>%
  ungroup()),
  (NumCompleteEMA %>%
     select(SID,WID,totalEMA)),
  by=c("SID","WID")) %>%
  mutate(ratio=round(count/totalEMA,3))

```


Descriptives
```{r, echo=FALSE, message=FALSE, warning=FALSE}
resave_graphs=FALSE

# Puberty Distribution
Female_Puberty<-ggplot(puberty, aes(x=PDS_Female,
                    colour=as.factor(WID)))+
               geom_density(alpha=.7,
                            size=1.5) +
  labs(x="Pubertal Measure",colour='Wave') +
  ggtitle("Puberty Distribution (Female)") +
  theme_kate()

Female_Puberty

if(resave_graphs){ggsave(plot = Female_Puberty,file=paste(workdir,"graphs/Female_PubertybyWave_dist.png",sep = ""),
        width = 6, height = 4, dpi = 300,units="in")}

Male_Puberty<-ggplot(puberty, aes(x=PDS_Male,
                    colour=as.factor(WID)))+
               geom_density(alpha=.7,
                            size=1.5) +
  labs(x="Pubertal Measure",colour='Wave') +
  ggtitle("Puberty Distribution (Male)") +
  theme_kate()

Male_Puberty

if(resave_graphs){ggsave(plot = Male_Puberty,file=paste(workdir,"graphs/Male_PubertybyWave_dist.png",sep = ""),
       width = 6, height = 4, dpi = 300,units="in")}

# Check distribution of Puberty Categories
puberty_dist_grade<-puberty %>%
  filter(!is.na(Puberty_Category)) %>%
  group_by(Puberty_Category,Gender,WID) %>%
  summarize(count=n())

# Plot distribution of Puberty Categories
Puberty_Categories<-ggplot(puberty_dist_grade, aes(x=WID,y=count,
                    colour=Puberty_Category)) +
  geom_line(aes(group=Puberty_Category), size=1)+
  facet_grid(.~Gender,
             scales='free')+
  labs(x="Wave",colour="Puberty Category") +
  ggtitle("Puberty Category Distribution") +
  theme_kate()
Puberty_Categories
if(resave_graphs){ggsave(plot = Puberty_Categories,file=paste(workdir,"graphs/Puberty_Categories_GroupedbyWave.png",sep = ""),
       width = 6, height = 4, dpi = 300,units="in")}

wave_labels<-c("1"="8th Grade","5"="9th Grade","9"="10th Grade","11"="11th grade")
gender_labels<-c("0" = "Female", "1" = "Male")
Puberty_Categories<-ggplot(puberty_dist_grade, aes(x=as.factor(Gender), y=count, fill=Puberty_Category)) +
    geom_bar(colour="black", stat="identity") +
  facet_grid(.~WID,
             scales='free',
              labeller=as_labeller(wave_labels))+
  labs(x="Gender",fill="Puberty Category") +
  ggtitle("Puberty Category Distribution") +
  scale_x_discrete(labels=c("0" = "Female", "1" = "Male"))+
  theme_kate()
Puberty_Categories
if(resave_graphs){ggsave(plot = Puberty_Categories,file=paste(workdir,"graphs/Puberty_Categories_GroupedbyGender.png",sep = ""),
       width = 8, height = 6, dpi = 150,units="in")}


# Opportunities Monitoring
opp_montioring_dist_mean<-ggplot(opportunities, aes(x=OppMonitorMean,
                    colour=as.factor(WID)))+
               geom_density(alpha=.7,
                            size=1.5) +
  labs(x="Opportunities Monitoring",colour='Wave') +
  ggtitle("Opportunities Monitoring (mean) Distribution by Wave") +
  theme_kate()

opp_montioring_dist_mean

if(resave_graphs){ggsave(plot = opp_montioring_dist_mean,file=paste(workdir,"graphs/opp_montioring_dist_mean.png",sep = ""),
       width = 6, height = 4, dpi = 300,units="in")}

opp_montioring_dist_total<-ggplot(opportunities, aes(x=OppMonitorTotal,
                    colour=as.factor(WID)))+
               geom_density(alpha=.7,
                            size=1.5) +
  labs(x="Opportunities Monitoring",colour='Wave') +
  ggtitle("Opportunities Monitoring (total) Distribution by Wave") +
  theme_kate()

opp_montioring_dist_total
if(resave_graphs){ggsave(plot = opp_montioring_dist_total,file=paste(workdir,"graphs/opp_montioring_dist_total.png",sep = ""),
       width = 6, height = 4, dpi = 300,units="in")}

# Dating Conflict
dating_conflict_dist_mean<-ggplot(dating_conflict, aes(x=DatingConflictMean,
                    colour=as.factor(WID)))+
               geom_density(alpha=.7,
                            size=1.5) +
  labs(x="Dating Conflict",colour='Wave') +
  ggtitle("Dating Conflict (mean) Distribution by Wave") +
  theme_kate()

dating_conflict_dist_mean

if(resave_graphs){ggsave(plot = dating_conflict_dist_mean,file=paste(workdir,"graphs/dating_conflict_dist_mean.png",sep = ""),
       width = 6, height = 4, dpi = 300,units="in")}

dating_conflict_dist_total<-ggplot(dating_conflict, aes(x=DatingConflictTotal,
                    colour=as.factor(WID)))+
               geom_density(alpha=.7,
                            size=1.5) +
  labs(x="Dating Conflict",colour='Wave') +
  ggtitle("Dating Conflict (total) Distribution by Wave") +
  theme_kate()

dating_conflict_dist_total

if(resave_graphs){ggsave(plot = dating_conflict_dist_total,file=paste(workdir,"graphs/dating_conflict_dist_total.png",sep = ""),
       width = 6, height = 4, dpi = 300,units="in")}

# Oldest Partner reported by Wave
age_oldest_partner_allwaves<-surveydata %>% 
  select(SID,WID,AgeOldBFGF2) %>%
  filter(!is.na(AgeOldBFGF2)) %>%
  group_by(SID) %>%
  do({oldest_age<-(sort(.$AgeOldBFGF2,decreasing = TRUE)[[1]])
      dplyr::mutate(.,oldest=oldest_age)
  })
age_partner_dist<-ggplot(left_join(age_oldest_partner_allwaves,
                                   (demographics %>% select(SID,Gender)),
                                   by="SID") %>% filter(!is.na(Gender)),
                         aes(x=AgeOldBFGF2,
                    colour=as.factor(WID)))+
               geom_density(alpha=.7,
                            size=1.5) +
  facet_grid(.~as.factor(Gender),
             scales='free',
             labeller=as_labeller(gender_labels))+
  labs(x="Age Oldest Partner",colour='Wave') +
  ggtitle("Age Oldest Partner Distribution by Wave") +
  theme_kate()
age_partner_dist
if(resave_graphs){ggsave(plot = age_partner_dist,
       file=paste(workdir,"graphs/age_partner_dist.png",sep = ""),
       width = 6, height = 4, dpi = 300,units="in")}
```

Analyses set up
```{r, message=FALSE, warning=FALSE}

# Question 1:
# Does Gender, Ethnicity, and/or Pubertal Status at Grade 8 predict likelihood to being in situations
# where sexual risk behavior could occur?
# IVs:  a) Gender
#       b) Ethnicity (identify as Latino)
#       c) Pubertal Status at Grade 8
# DVs:  a) Opportunities monitoring score at Grade 9
#       b) Having an older partner
#       c) EMA time unsupervised w/ partner at Grade 9 + summer

# Analysis 1a:
# Create data frame with IVs and Opportunities monitoring score at Grade 9
thedata<-left_join((opportunities %>%
                      filter(WID==c(5)) %>%
                      select(SID,OppMonitorMean)),
                   (puberty %>%
                      filter(WID==c(1)) %>%
                      select(SID,Gender,Latino,Puberty_3group)),
                    by = c("SID")) %>%
  mutate(Gender=ifelse(Gender==0,"Female",
                       ifelse(Gender==1,"Male",NA))) %>%
  mutate(Gender=as.factor(Gender),
         Puberty_3group=as.factor(Puberty_3group),
         Ethnicity=as.factor(Latino))

# Since we're only looking at correlations between a single time points, use regular linear regression
gender_pred_oppmon<-lm(OppMonitorMean ~ Gender, data=thedata, na.action=na.omit)
ethnicity_pred_oppmon<-lm(OppMonitorMean ~ Ethnicity, data=thedata, na.action=na.omit)
gender_ethnicity_pred_oppmon<-lm(OppMonitorMean ~ Gender*Ethnicity, data=thedata, na.action=na.omit)
puberty_pred_oppmon<-lm(OppMonitorMean ~ Puberty_3group, data=thedata, na.action=na.omit)
puberty_gender_pred_oppmon<-lm(OppMonitorMean ~ Gender * Puberty_3group,  data=thedata, na.action=na.omit)
puberty_ethnicity_gender_pred_oppmon<-lm(OppMonitorMean ~ Gender*Ethnicity*Puberty_3group,  data=thedata, na.action=na.omit)

# Check out the results
anova(gender_pred_oppmon)
summary(gender_pred_oppmon)
anova(ethnicity_pred_oppmon)
anova(gender_ethnicity_pred_oppmon)
anova(puberty_pred_oppmon)
anova(puberty_gender_pred_oppmon)
anova(puberty_ethnicity_gender_pred_oppmon)


# Analysis 1b:
# Create data frame with IVs and Age oldest partner at Grade 9
thedata<-left_join((age_oldest_partner %>%
                      filter(WID==c(5)) %>%
                      select(SID,oldest)),
                   (puberty %>%
                      filter(WID==c(1)) %>%
                      select(SID,Gender,Latino,Puberty_3group)),
                    by = c("SID")) %>%
  mutate(Gender=ifelse(Gender==0,"Female",
                       ifelse(Gender==1,"Male",NA))) %>%
  mutate(Gender=as.factor(Gender),
         Puberty_3group=as.factor(Puberty_3group),
         Ethnicity=as.factor(Latino))

# Since we're only looking at correlations between a single time points, use regular linear regression
gender_pred_ageoldpartner<-lm(oldest ~ Gender, data=thedata, na.action=na.omit)
ethnicity_pred_ageoldpartner<-lm(oldest ~ Ethnicity, data=thedata, na.action=na.omit)
gender_ethnicity_pred_ageoldpartner<-lm(oldest ~ Gender*Ethnicity, data=thedata, na.action=na.omit)
puberty_pred_ageoldpartner<-lm(oldest ~ Puberty_3group, data=thedata, na.action=na.omit)
puberty_gender_pred_ageoldpartner<-lm(oldest ~ Gender * Puberty_3group,  data=thedata, na.action=na.omit)
puberty_ethnicity_gender_pred_ageoldpartner<-lm(oldest ~ Gender*Ethnicity*Puberty_3group,  data=thedata, na.action=na.omit)

# Check out the results
anova(gender_pred_ageoldpartner)
summary(gender_pred_ageoldpartner)
anova(ethnicity_pred_ageoldpartner)
summary(ethnicity_pred_ageoldpartner)
anova(gender_ethnicity_pred_ageoldpartner)
summary(gender_ethnicity_pred_ageoldpartner)
anova(puberty_pred_ageoldpartner)
summary(puberty_pred_ageoldpartner)
anova(puberty_gender_pred_ageoldpartner)
anova(puberty_ethnicity_gender_pred_ageoldpartner)


# Analysis 1c:
# Create data frame with IVs and EMA Ratio of time unsupervised w/ BFGF
thedata<-left_join((EMA_count %>%
                      filter(WithBFGF=="Yes" & AdultPresent=="No") %>%
                      select(SID,WID,ratio) %>%
                      group_by(SID) %>%
                      summarize(EMAaloneBFGF=round(mean(ratio),3))%>%
                      ungroup()),
                   (puberty %>%
                      filter(WID==c(1)) %>%
                      select(SID,Gender,Latino,Puberty_3group)),
                    by = c("SID")) %>%
  mutate(Gender=ifelse(Gender==0,"Female",
                       ifelse(Gender==1,"Male",NA))) %>%
  mutate(Gender=as.factor(Gender),
         Puberty_3group=as.factor(Puberty_3group),
         Ethnicity=as.factor(Latino))

# Since we're only looking at correlations between a single time points, use regular linear regression
gender_pred_EMAaloneBFGF<-lm(EMAaloneBFGF ~ Gender, data=thedata, na.action=na.omit)
ethnicity_pred_EMAaloneBFGF<-lm(EMAaloneBFGF ~ Ethnicity, data=thedata, na.action=na.omit)
gender_ethnicity_pred_EMAaloneBFGF<-lm(EMAaloneBFGF ~ Gender*Ethnicity, data=thedata, na.action=na.omit)
puberty_pred_EMAaloneBFGF<-lm(EMAaloneBFGF ~ Puberty_3group, data=thedata, na.action=na.omit)
puberty_gender_pred_EMAaloneBFGF<-lm(EMAaloneBFGF ~ Gender * Puberty_3group,  data=thedata, na.action=na.omit)
puberty_ethnicity_gender_pred_EMAaloneBFGF<-lm(EMAaloneBFGF ~ Gender*Ethnicity*Puberty_3group,  data=thedata, na.action=na.omit)

# Check out the results
anova(gender_pred_EMAaloneBFGF)
summary(gender_pred_EMAaloneBFGF)
anova(ethnicity_pred_EMAaloneBFGF)
anova(gender_ethnicity_pred_EMAaloneBFGF)
anova(puberty_pred_EMAaloneBFGF)
anova(puberty_gender_pred_EMAaloneBFGF)
anova(puberty_ethnicity_gender_pred_EMAaloneBFGF)

# Analysis 1d:
# Create data frame DVs to examine relationships
thedata<-left_join((EMA_count %>%
                      filter(WithBFGF=="Yes" & AdultPresent=="No") %>%
                      select(SID,WID,ratio) %>%
                      group_by(SID) %>%
                      summarize(EMAaloneBFGF=round(mean(ratio),3))%>%
                      ungroup()),
                   (age_oldest_partner %>%
                      filter(WID==c(5)) %>%
                      select(SID,oldest)),
                    by=("SID"))

thedata<-left_join(thedata,(opportunities %>%
                      filter(WID==c(5)) %>%
                      select(SID,OppMonitorMean)),
                   by=("SID"))

# Since we're only looking at correlations between a single time points, use regular linear regression
oppmon_pred_EMAaloneBFGF<-lm(EMAaloneBFGF ~ OppMonitorMean, data=thedata, na.action=na.omit)
ageoldpartner_pred_EMAaloneBFGF<-lm(EMAaloneBFGF ~ oldest, data=thedata, na.action=na.omit)

# Check out the results
anova(oppmon_pred_EMAaloneBFGF)
summary(oppmon_pred_EMAaloneBFGF)
anova(ageoldpartner_pred_EMAaloneBFGF)

###########################################
# Question 2:
# What predicts conflict in dating behavior?
# IVs:  a) Gender
#       b) Ethnicity
#       c) Pubertal Status at Grade 8
#       d) EMA time unsupervised w/ partner at Grade 9 + summer
#       e) Opportunities monitoring score at Grade 9
#       f) Age of BF/GF Grade 10
# DVs:  a) Conflict dating behavior Grade 10

# Analysis 2a:
# Create data frame with IVs a,b&c and Conflict dating behavior Grade 10
thedata<-left_join((dating_conflict %>%
                      filter(WID==c(9)) %>%
                      select(SID,DatingConflictMean)),
                   (puberty %>%
                      filter(WID==c(1)) %>%
                      select(SID,Gender,Latino,Puberty_3group)),
                    by = c("SID")) %>%
  mutate(Gender=ifelse(Gender==0,"Female",
                       ifelse(Gender==1,"Male",NA))) %>%
  mutate(Gender=as.factor(Gender),
         Puberty_3group=as.factor(Puberty_3group),
         Ethnicity=as.factor(Latino))


# Since we're only looking at correlations between a single time points, use regular linear regression
gender_pred_datingconflict<-lm(DatingConflictMean ~ Gender, data=thedata, na.action=na.omit)
ethnicity_pred_datingconflict<-lm(DatingConflictMean ~ Ethnicity, data=thedata, na.action=na.omit)
gender_ethnicity_pred_datingconflict<-lm(DatingConflictMean ~ Gender*Ethnicity, data=thedata, na.action=na.omit)
puberty_pred_datingconflict<-lm(DatingConflictMean ~ Puberty_3group, data=thedata, na.action=na.omit)
puberty_gender_pred_datingconflict<-lm(DatingConflictMean ~ Gender * Puberty_3group,  data=thedata, na.action=na.omit)
puberty_ethnicity_gender_pred_datingconflict<-lm(DatingConflictMean ~ Gender*Ethnicity*Puberty_3group,  data=thedata, na.action=na.omit)

# Check out the results
anova(gender_pred_datingconflict)
anova(ethnicity_pred_datingconflict)
summary(ethnicity_pred_datingconflict)
anova(gender_ethnicity_pred_datingconflict)
anova(puberty_pred_datingconflict)
anova(puberty_gender_pred_datingconflict)
anova(puberty_ethnicity_gender_pred_datingconflict)


# Analysis 2b:
# Create data frame with IVs d,e&f and Conflict dating behavior Grade 10
thedata<-left_join((dating_conflict %>%
                      filter(WID==c(9)) %>%
                      select(SID,DatingConflictMean)),
                   (puberty %>%
                      filter(WID==c(1)) %>%
                      select(SID,Gender,Latino,Puberty_3group)),
                    by = c("SID")) %>%
  mutate(Gender=ifelse(Gender==0,"Female",
                       ifelse(Gender==1,"Male",NA))) %>%
  mutate(Gender=as.factor(Gender),
         Puberty_3group=as.factor(Puberty_3group),
         Ethnicity=as.factor(Latino))

thedata<-left_join(thedata,(opportunities %>%
                      filter(WID==c(5)) %>%
                      select(SID,OppMonitorMean)),by=c("SID"))
thedata<-left_join(thedata,(age_oldest_partner %>%
                      filter(WID==c(5)) %>%
                      select(SID,oldest)),by=c("SID"))
thedata<-left_join(thedata,(EMA_count %>%
                      filter(WithBFGF=="Yes" & AdultPresent=="No") %>%
                      select(SID,WID,ratio) %>%
                      group_by(SID) %>%
                      summarize(EMAaloneBFGF=round(mean(ratio),3))%>%
                      ungroup()),by=c("SID"))


# Since we're only looking at correlations between a single time points, use regular linear regression
oppmon_pred_datingconflict<-lm(DatingConflictMean ~ OppMonitorMean, data=thedata, na.action=na.omit)
ageoldpartner_pred_datingconflict<-lm(DatingConflictMean ~ oldest, data=thedata, na.action=na.omit)
EMAaloneBFGF_pred_datingconfict<-lm(DatingConflictMean ~ EMAaloneBFGF, data=thedata, na.action=na.omit)

anova(oppmon_pred_datingconflict)
summary(oppmon_pred_datingconflict)
anova(ageoldpartner_pred_datingconflict)
anova(EMAaloneBFGF_pred_datingconfict)


# Interactions
oppmon_ethnicity_pred_datingconflict<-lm(DatingConflictMean ~ OppMonitorMean*Ethnicity, data=thedata, na.action=na.omit)

anova(oppmon_ethnicity_pred_datingconflict)
summary(oppmon_ethnicity_pred_datingconflict)
```

Plot results
```{r, message=FALSE, warning=FALSE}
## Correlate Puberty Mean by Opportunity Monitor Mean
ggplot(thedata,aes(y=OppMonitorMean,
                   x=Puberty)) +
  geom_point(color='maroon4',alpha=.3)+
  geom_smooth(method=lm,
                aes(y=OppMonitorMean,
                   x=Puberty),
                size=.7,
                alpha=0.2,
                colour="maroon1",
                fill = "maroon1")+
  labs(x='Puberty Grade 8',
       y='Dating Conflict Mean Grade 10') +
  theme_kate()



## Correlate Opportunity Monitor Mean by Dating Conflict Mean
ggplot(thedata,aes(x=OppMonitorMean,
                   y=DatingConflictMean)) +
  geom_point(color='maroon4',alpha=.3)+
  geom_smooth(method=lm,
                aes(x=OppMonitorMean,
                    y=DatingConflictMean),
                size=.7,
                alpha=0.2,
                colour="maroon1",
                fill = "maroon1")+
  labs(x='Opportunity Monitor Mean Grade 9',
       y='Dating Conflict Mean Grade 10') +
  theme_kate()

```